
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pourquoi les threads c’est délicat ? &#8212; Python Avancé</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinx-book-theme.5f77b4aec8189eecf79907ce328c390d.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="premiers exemples" href="b-s2-examples.html" />
    <link rel="prev" title="programmation asynchrone" href="b-s1-programmation-asynchrone.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      <h1 class="site-logo" id="site-title">Python Avancé</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="1-01-snake.html">
   UE12 - Python avancé
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  types de base
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="2-01-numbers.html">
   les nombres
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="2-02-containers-1.html">
   les containers (1/2)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="2-03-strings.html">
   chaines et binaire (
   <code class="docutils literal notranslate">
    <span class="pre">
     str
    </span>
   </code>
   et
   <code class="docutils literal notranslate">
    <span class="pre">
     bytes
    </span>
   </code>
   )
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="2-04-files.html">
   les fichiers
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="2-05-containers-2.html">
   les containers (2/2)
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  présentation
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="3-11-pep008.html">
   présentation du code
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  itérations
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="4-11-iterations-1.html">
   les itérations en Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="4-12-iterations-2.html">
   les itérations - suite
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  classes
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="5-11-classes.html">
   classes : rappels (1)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="5-12-dunder-specials.html">
   classes : rappels (2)
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  fonctions
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="6-00-intro.html">
   cours 6/9 : fonctions
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  regexps
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="7-10-regexps.html">
   expressions régulières
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  générateurs
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="7-20-generators.html">
   les générateurs
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  héritage
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="7-30-inheritance.html">
   POO &amp; héritage
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  organisation des sources
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="8-10-imports-sources.html">
   Imports et organisation du code
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  divers
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="9-10-argparse.html">
   écrire un lanceur / point d’entrée
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="9-11-properties.html">
   properties
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  notebooks interactifs
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="a-a1-profiling.html">
   étude de performances
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="a-b1-linting.html">
   Qualité du code
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="a-c3-notebooks-interactifs.html">
   Notebooks interactifs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="a-c4-animations-matplotlib.html">
   Animations interactives avec
   <code class="docutils literal notranslate">
    <span class="pre">
     matplotlib
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="a-c5-bokeh-et-al.html">
   Autres bibliothèques de visualisation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="a-c6-fourier-k3d.html">
   Application à la transformée de Fourier
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="a-x1-taylor.html">
   Le théorème de Taylor illustré
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="a-x2-coronavirus.html">
   Coronavirus
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="a-x3-potentials.html">
   Tracés de champs de vitesses
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Python asynchrone
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="b-01-os-basics.html">
   rappels
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="b-s1-programmation-asynchrone.html">
   programmation asynchrone
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Pourquoi les
   <em>
    threads
   </em>
   c’est délicat ?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="b-s2-examples.html">
   premiers exemples
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="b-s3-ecosysteme.html">
   <code class="docutils literal notranslate">
    <span class="pre">
     asyncio
    </span>
   </code>
   : historique et écosystème
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="b-s4-async-with-for.html">
   extensions asynchrones du langage
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="b-s6-av-event-loops.html">
   boucle d’événements
   <code class="docutils literal notranslate">
    <span class="pre">
     asyncio
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="b-s7-libraries.html">
   les librairies disponibles
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        <a class="dropdown-buttons"
            href="_sources/b-s1-z1-thread-safety.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download notebook file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/b-s1-z1-thread-safety.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/ue12/python-advanced"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/ue12/python-advanced/issues/new?title=Issue%20on%20page%20%2Fb-s1-z1-thread-safety.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/ue12/python-advanced/edit/main/notebooks/b-s1-z1-thread-safety.md"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/ue12/python-advanced/main?urlpath=tree/notebooks/b-s1-z1-thread-safety.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#complement-niveau-avance">
   Complément - niveau avancé
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#avertissement-pas-que-pour-python">
   avertissement : pas que pour Python
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#processus-et-threads">
   processus et threads
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#le-scheduler">
   le scheduler
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#context-switches">
     <em>
      context switches
     </em>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#une-simple-operation-d-addition">
   une simple opération d’addition
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#dans-deux-threads-un-scenario-favorable">
   dans deux threads, un scénario favorable
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#toujours-2-threads-mais-pas-de-chance">
   toujours 2 threads, mais pas de chance
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#phenomene-general">
   phénomène général
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#verrou-et-exclusion-mutuelle">
   verrou et exclusion mutuelle
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#ce-qu-il-faut-retenir">
   ce qu’il faut retenir
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#le-cas-de-python-le-gil">
   le cas de Python : le
   <strong>
    GIL
   </strong>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pour-en-savoir-plus">
   pour en savoir plus
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#remarque-a-propos-des-verrous">
     remarque à propos des verrous
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="licence">
<span>Licence CC BY-NC-ND</span>
<span>Thierry Parmentelat</span>
<span><img src="media/inria-25--alpha.png" /></span>
</div><div class="section" id="pourquoi-les-threads-c-est-delicat">
<h1>Pourquoi les <em>threads</em> c’est délicat ?<a class="headerlink" href="#pourquoi-les-threads-c-est-delicat" title="Permalink to this headline">¶</a></h1>
<div class="section" id="complement-niveau-avance">
<h2>Complément - niveau avancé<a class="headerlink" href="#complement-niveau-avance" title="Permalink to this headline">¶</a></h2>
<p>À nouveau dans ce cours nous nous intéressons aux applications qui sont plutôt <em>I/O intensive</em>. Cela dit et pour mettre les choses en perspective, on pourrait se dire que <em>qui peut le plus peut le moins</em>, et que le multi-threading qui est bien adapté au calcul parallèle <em>CPU-intensive</em>, pourrait aussi bien faire l’affaire dans le contexte de l’<em>I/O-intensive</em>.</p>
<p>Il se trouve qu’en fait le multi-theading présente un inconvénient assez notable, que nous allons tenter de mettre en évidence dans ce complément; sur un exemple hyper-simple, nous allons illustrer la notion de <em>section critique</em>, et montrer pourquoi on doit utiliser parfois - trop souvent - la notion de <em>lock</em> ou verrou lorsqu’on utilise des <em>threads</em>.</p>
</div>
<div class="section" id="avertissement-pas-que-pour-python">
<h2>avertissement : pas que pour Python<a class="headerlink" href="#avertissement-pas-que-pour-python" title="Permalink to this headline">¶</a></h2>
<p>Je dois préciser avant d’aller plus loin que pour cette discussion, nous allons oublier le cas spécifique de Python; les notions que nous abordons tournent autour des relations entre l’OS et les applications, qui sont valables en général.</p>
<p>En fait c’est même pire que ça, et nous verrons les implications pour Python à la fin du complément; vous avez peut-être déjà entendu parler du <em><strong>GIL</strong></em>, mais on va avoir besoin d’appréhender cette histoire de section critique pour mieux comprendre les tenants et les aboutissements du <em><strong>GIL</strong></em> en Python.</p>
</div>
<div class="section" id="processus-et-threads">
<h2>processus et threads<a class="headerlink" href="#processus-et-threads" title="Permalink to this headline">¶</a></h2>
<p>On rappelle que, pour écrire des programmes parallèles, l’<em>Operating System</em> nous offre principalement deux armes :</p>
<ul class="simple">
<li><p>les processus</p></li>
<li><p>les threads</p></li>
</ul>
<p>Il faut se souvenir que la première fonction de l’OS est <em>justement</em> que plusieurs programmes puissent s’exécuter <em>en même temps</em>, c’est-à-dire partager les ressources physiques de l’ordinateur, et notamment le CPU et la mémoire, sans pouvoir se contaminer l’un l’autre.</p>
<p>Aussi, c’est <strong>par construction</strong> que deux processus différents se retrouvent dans des espaces totalement étanches, et qu’un processus <strong>ne peut pas</strong> accéder à la mémoire d’un autre processus.</p>
<p>On peut naturellement utiliser des processus pour faire du calcul parallèle, mais cette contrainte de naissance rend l’exercice fastidieux, surtout lorsque les différents programmes sont très dépendants les uns des autres, car dans ce cas bien sûr ils <strong>ont besoin</strong> d’échanger voire de partager des données (je m’empresse de préciser qu’il existe des mécanismes pour faire ça - notamment : librairies de mémoire partagée, envoi de messages - mais qui induisent leur propre complexité…).</p>
<p>Par contraste un processus peut contenir plusieurs threads, chacun disposant pour faire court, d’une pile et d’un pointeur de programme - en gros donc, <strong>où on en est</strong> dans la logique de <strong>une exécution séquentielle</strong>; l’intérêt étant que de tous <strong>les threads partagent</strong> à présent la mémoire du processus; c’est donc un modèle <em>a priori</em> très attractif pour notre sujet.</p>
</div>
<div class="section" id="le-scheduler">
<h2>le scheduler<a class="headerlink" href="#le-scheduler" title="Permalink to this headline">¶</a></h2>
<p>Comme ces notions de processus et de threads sont fournies par l’OS, c’est à lui également que revient la responsabilité de les faire tourner; cela est fait dans le noyau par ce qu’on appelle le <em>scheduler</em>.</p>
<p>Comment ça marche ? dans le détail, c’est un sujet très copieux, il existe une littérature hyper-abondante sur le sujet, et donc une extrême variété de stratégies et de réglages possibles.</p>
<p>Mais pour ce qui nous intéresse, nous n’allons retenir que ces caractéristiques de haut niveau très simples :</p>
<ul class="simple">
<li><p>le scheduler maintient une liste de processus et de threads à faire tourner;</p></li>
<li><p>il décide - à une fréquence assez élevée - de leur donner la main à tour de rôle;</p></li>
<li><p>simplement il faut bien réaliser qu’à ce stade, ce que manipule le scheduler, c’est essentiellement du code binaire, très proche du processeur, après toutes les phases de compilation et optimisation.</p></li>
</ul>
<div class="section" id="context-switches">
<h3><em>context switches</em><a class="headerlink" href="#context-switches" title="Permalink to this headline">¶</a></h3>
<p>L’instant où le scheduler décide de suspendre l’exécution d’un processus - ou thread - pour donner la main à un autre, s’appelle un *<strong>context switch</strong>; on parle de <em><strong>process switch</strong></em> lorsqu’on passe d’un processus à un autre, et de <em><strong>task switch</strong></em> ou <em><strong>thread switch</strong></em> lorsqu’on passe d’un thread à un autre à l’intérieur d’un processus.</p>
<p>Le point important pour nous, c’est que le scheduler est un morceau de code générique, il fait donc son travail de manière neutre pour tous les processus ou threads, indépendamment du langage par exemple, ou du domaine d’application; et que le découpage du temps en slots alloués aux différents joueurs se fait bien évidemment sur la base des instuctions élémentaires du processeur - ce qu’on appelle <strong>les cycles</strong>.</p>
<p>On s’intéresse davantage aux threads dans la suite, et nous allons voir que dans ce cas, cela crée parfois de mauvaises surprises.</p>
</div>
</div>
<div class="section" id="une-simple-operation-d-addition">
<h2>une simple opération d’addition<a class="headerlink" href="#une-simple-operation-d-addition" title="Permalink to this headline">¶</a></h2>
<p>Pour illustrer notre propos, nous allons étudier une opération extrêmement banale qui consiste à incrémenter la valeur d’une variable.</p>
<p>Il se trouve qu’en pratique cette opération se décompose en réalité en 3 opérations élémentaires, comme le montre la figure suivante; à nouveau le langage utilisé dans toutes ces illustrations n’est pas du Python - typiquement une opération comme celle-ci en Python va occasionner bien plus d’instructions élémentaires que cela - disons pour fixer les idées que c’est quelque chose comme du C; peu importe en fait, c’est l’idée qui est importante.</p>
<hr class="docutils" />
<p><img alt="" src="_images/thread-safety-1.svg" /></p>
<p><span style="font-size: larger;"><strong>Figure 1 :</strong> une instruction du genre de <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">=</span> <span class="pre">a</span> <span class="pre">+</span> <span class="pre">1</span></code> dans un langage compilé, avec un seul thread</span></p>
<hr class="docutils" />
<p>On voit sur cette figure la logique des trois opérations</p>
<ul class="simple">
<li><p>dans un premier temps on va chercher la valeur de la variable <code class="docutils literal notranslate"><span class="pre">a</span></code> qu’on range disons dans un registre - ou un cache;</p></li>
<li><p>on réalise l’incrémentation de cette valeur dans le registre</p></li>
<li><p>puis on recopie le résultat dans la case mémoire originelle, qui correspond à la variable <code class="docutils literal notranslate"><span class="pre">a</span></code></p></li>
</ul>
<p>Ce programme fait donc bien ce qu’on veut; si la valeur de <code class="docutils literal notranslate"><span class="pre">a</span></code> était 10 au début, on y trouve <code class="docutils literal notranslate"><span class="pre">11</span></code> à la fin, tout va bien.</p>
</div>
<div class="section" id="dans-deux-threads-un-scenario-favorable">
<h2>dans deux threads, un scénario favorable<a class="headerlink" href="#dans-deux-threads-un-scenario-favorable" title="Permalink to this headline">¶</a></h2>
<p>À présent, nous allons imaginer le cas de <strong>deux threads</strong> qui s’exécutent en parallèle, avec un seul processeur;<br />
et admettons que chacun des deux threads exécute une fois <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">=</span> <span class="pre">a</span> <span class="pre">+</span> <span class="pre">1</span></code> sur une variable globale <code class="docutils literal notranslate"><span class="pre">a</span></code>.</p>
<p>En admettant comme tout à l’heure que <code class="docutils literal notranslate"><span class="pre">a</span></code> valait <code class="docutils literal notranslate"><span class="pre">10</span></code> en commençant, on s’attend donc naturellement à ce qu’à la fin <code class="docutils literal notranslate"><span class="pre">a</span></code> vaille <code class="docutils literal notranslate"><span class="pre">12</span></code> puisqu’on l’aura incrémenté deux fois.</p>
<p>Voyons d’abord un scénario qui se passe bien; le scheduler qui, donc, donne la main alternativement à l’un et l’autre de nos deux threads, a la bonne idée de laisser intègres les deux blocs de 3 instructions, sans y insérer de <em>context switching</em>.</p>
<hr class="docutils" />
<p><img alt="" src="_images/thread-safety-2.svg" /></p>
<p><span style="font-size: larger"><strong>Figure 2 :</strong> deux threads, un processeur, dans un scénario favorable</span></p>
<hr class="docutils" />
<p>Dans ce scénario, à l’issue des deux threads on a bien, comme attendu, <strong><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">==</span> <span class="pre">12</span></code></strong>.</p>
</div>
<div class="section" id="toujours-2-threads-mais-pas-de-chance">
<h2>toujours 2 threads, mais pas de chance<a class="headerlink" href="#toujours-2-threads-mais-pas-de-chance" title="Permalink to this headline">¶</a></h2>
<p>Mais en fait, il y a un souci avec cette façon de faire.</p>
<p>Ce qu’il faut bien comprendre c’est que du point de vue du scheduler, toutes ces instructions sont pareilles et il n’y a pas, à ce stade, de moyen pour le scheduler, de traiter ce bloc de 3 instructions de manière particulière.</p>
<p>Aussi le scheduler, qui a déjà un travail assez compliqué si on tient compte du fait qu’il doit être <em>fair</em> (donner autant de temps à tout le monde), choisit les points de <em>context switching</em> comme il le peut au milieu de ce qui, pour lui, n’est qu’une longue liste d’instructions.</p>
<p>Imaginons du coup un scénario moins favorable que le précédent, dans lequel le scheduler, pas de chance, choisit de faire un context switching <strong>juste après le premier <em>LOAD</em></strong> du premier thread; ça nous donne alors l’exécution décrite dans cette figure :</p>
<hr class="docutils" />
<p><img alt="" src="_images/thread-safety-3.svg" /></p>
<p><span style="font-size: larger"><strong>Figure 3 :</strong> deux threads, un processeur, mais un choix de scheduling malheureux</span></p>
<hr class="docutils" />
<p>Du coup ce qui se passe ici, c’est que le deuxième fil fait son <em>LOAD</em> à partir de la variable <code class="docutils literal notranslate"><span class="pre">a</span></code> qui <strong>n’a pas encore été modifiée</strong>, et du coup les deux threads incrémentent tous les deux la valeur 10, et à l’issue de l’exécution des deux threads, on a maintenant <strong><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">==</span> <span class="pre">11</span></code></strong> !!</p>
<p>Pour résumer donc : on part de <strong><code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">==</span> <span class="pre">10</span></code></strong>, on exécute 2 threads qui font tous les deux <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">=</span> <span class="pre">a</span> <span class="pre">+</span> <span class="pre">1</span></code> et au final, on se retrouve avec <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">==</span> <span class="pre">11</span></code>; gros souci donc !</p>
</div>
<div class="section" id="phenomene-general">
<h2>phénomène général<a class="headerlink" href="#phenomene-general" title="Permalink to this headline">¶</a></h2>
<p>À ce stade vous pourriez vous dire que j’ai triché, et que j’ai choisi un scénario irréaliste; par exemple qu’en pratique l’incrémentation de 1 ça se fait en hardware en une seule instruction.</p>
<p>Oui bien sûr, l’exemple est choisi pour rester aussi simple que possible; mais si vous n’êtes pas convaincu avec <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">=</span> <span class="pre">a</span> <span class="pre">+</span> <span class="pre">1</span></code>, prenez simplement <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">=</span> <span class="pre">a</span> <span class="pre">+</span> <span class="pre">b</span></code>, vous verrez que c’est exactement le même souci.</p>
<p>En fait le souci que l’on a, de manière générale, c’est que :</p>
<ul class="simple">
<li><p>dans un langage de programmation un tout petit peu évolué, un fragment de code (même réduit à une instruction) se traduit presque toujours en <strong>plusieurs instructions binaires</strong> pour le processeur</p></li>
<li><p>pour que le programme fonctionne correctement dans un mode multi-thread, certains fragments de code, et notamment ceux qui <strong>accèdent à de la mémoire partagée</strong>,  doivent être <strong>exécutés de façon atomique</strong> (c-à-d ne pas être interrompus en plein milieu par le scheduler)</p></li>
<li><p>et sans aide du programmeur, le scheduler n’a <strong>aucun moyen de savoir où</strong>, dans le flot d’instruction binaires, il est légitime ou pas de <strong>faire un context switching</strong>.</p></li>
</ul>
<p>Et avec quelque chose d’un tout petit peu plus compliqué comme <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">=</span> <span class="pre">2</span> <span class="pre">*</span> <span class="pre">a;</span> <span class="pre">a</span> <span class="pre">=</span> <span class="pre">a</span> <span class="pre">+</span> <span class="pre">1</span></code>, on n’a même pas besoin de descendre au niveau du code machine pour exhiber le problème…</p>
</div>
<div class="section" id="verrou-et-exclusion-mutuelle">
<h2>verrou et exclusion mutuelle<a class="headerlink" href="#verrou-et-exclusion-mutuelle" title="Permalink to this headline">¶</a></h2>
<p>Du coup, pour rendre la programmation par thread utilisable en pratique, il faut lui adjoindre des mécanismes, accessibles au programmeur, pour rendre explicite ce type de problèmes.</p>
<p>La notion <strong>la plus simple</strong> de ces mécanismes est celle de <strong>verrou</strong> pour implémenter une <strong>exclusion mutuelle</strong>; pour en donner une illustration très rapide, voyons cela sur notre exemple.</p>
<p>Nous allons remplacer ceci :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># thread A</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># thread B</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</div>
<p>par ceci</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># thread A</span>

<span class="n">get_lock</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">release_lock</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># thread B</span>

<span class="n">get_lock</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">release_lock</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span>
</pre></div>
</div>
<p>Dans cette nouvelle version, un nouvel objet global <code class="docutils literal notranslate"><span class="pre">lock</span></code> est introduit, qui peut être dans deux états <em>libre</em> ou <em>occupé</em>.</p>
<p>De cette façon, celui des deux threads qui arrive à ce stade en premier obtient le verrou (le met dans l’état <em>occupé</em>), et fait son traitement avant de le relâcher; du coup l’autre doit attendre que le premier ait fini <strong>tout le traitement</strong> de sa <strong>section critique</strong> pour pouvoir commencer le sien.</p>
<p>Comme on le voit, l’idée consiste à permettre au programmeur de <strong>rendre explicite</strong> l’exclusion mutuelle qu’il est nécessaire d’assurer pour que le programme fonctionne comme prévu, et de façon déterministe.</p>
</div>
<div class="section" id="ce-qu-il-faut-retenir">
<h2>ce qu’il faut retenir<a class="headerlink" href="#ce-qu-il-faut-retenir" title="Permalink to this headline">¶</a></h2>
<p>Pour conclure cette partie, retenons que l’<strong>on peut</strong> écrire du code <strong>multi-thread</strong> dont le comportement est <strong>déterministe</strong>, mais <strong>au prix de l’ajout dans le code</strong> d’annotations qui limitent les modes d’exécution; ce qui a tendance à rendre les choses <strong>complexes</strong>, et donc <strong>coûteuses</strong>.</p>
<p>Et retenons que le problème principal ici est lié à l’<strong>absence de contrôle</strong>, par le programmeur, sur les <em>context switchings</em>; et du coup ceux-ci peuvent intervenir <strong>à n’importe quel moment</strong>.</p>
<p>Nous verrons que la situation est très différente avec le paradigme <code class="docutils literal notranslate"><span class="pre">async/await/asyncio</span></code>.</p>
</div>
<div class="section" id="le-cas-de-python-le-gil">
<h2>le cas de Python : le <strong>GIL</strong><a class="headerlink" href="#le-cas-de-python-le-gil" title="Permalink to this headline">¶</a></h2>
<p>Dans ce contexte, le cas des programmes Python est un peu spécial; ce n’est pas un langage compilé, ce qui signifie que du point de vue de l’OS et du scheduler, le processus qui tourne est en fait l’interpréteur Python.</p>
<p>Et il se trouve que l’interpréteur Python est un exemple de programme qui pourrait être sensible au type de problèmes que nous venons d’étudier.</p>
<p>Voyons un exemple pour vous faire entrevoir la complexité du sujet.
Vous vous souvenez qu’on a parlé de garbage collection, et de compteur de références.
Voyons comment le fait de maintenir un compteur de références crée le besoin d’<strong>écrire</strong> dans la mémoire, alors qu’en lisant le code Python on ne voit que des <strong>accès en lecture</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># on est bien d&#39;accord que ce code ne fait que lire</span>
<span class="c1"># le contenu de x et ne modifie pas sa valeur</span>

<span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span>  <span class="n">max_depth</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;in </span><span class="si">{</span><span class="n">depth</span><span class="si">}</span><span class="s2">th function call we see </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">depth</span> <span class="o">&lt;</span> <span class="n">max_depth</span><span class="p">:</span>
        <span class="n">foo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">max_depth</span><span class="p">,</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># j&#39;exécute ce code sur un objet tout neuf</span>
<span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># et je confirme bien qu&#39;on n&#39;y touche jamais</span>
<span class="n">foo</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>in 1th function call we see []
in 2th function call we see []
in 3th function call we see []
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># mais en fait pendant toute l&#39;exécution de ce code</span>
<span class="c1"># il y a des changements qui sont faits dans l&#39;objet a </span>
<span class="c1"># en tous cas dans sa représentation interne,</span>
<span class="c1"># regardons notamment le compteur de références</span>

<span class="c1"># pour importer getrefcount() qui permet de </span>
<span class="c1"># lire le compteur de références d&#39;un objet</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="c1"># la même logique exactement que plus haut,</span>
<span class="c1"># mais ici affiche aussi le compteur de références </span>
<span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span>  <span class="n">max_depth</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;in </span><span class="si">{</span><span class="n">depth</span><span class="si">}</span><span class="s2">th function call we see </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2"> that has </span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">getrefcount</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="si">}</span><span class="s2"> refs&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">depth</span> <span class="o">&lt;</span> <span class="n">max_depth</span><span class="p">:</span>
        <span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">max_depth</span><span class="p">,</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        
<span class="n">bar</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>in 1th function call we see [] that has 4 refs
in 2th function call we see [] that has 6 refs
in 3th function call we see [] that has 8 refs
</pre></div>
</div>
</div>
</div>
<p>Du coup, et précisément pour protéger son fonctionnement intime, l’interpréteur Python est implémenté de telle sorte à <strong>empêcher l’exécution simultanée</strong> de plusieurs threads dans un même processus Python ! Cela est fait au travers d’un verrou central pour tout l’interpréteur, qui s’appelle <strong>le GIL</strong> - le <em>Global Interpreter Lock</em>.</p>
<p>Aussi, bien qu’il est possible - notamment au travers de la librairie <code class="docutils literal notranslate"><span class="pre">threading</span></code> - de concevoir des programmes multi-threadés en Python, par construction, ils ne peuvent pas s’exécuter en parallèle, et notamment ne peuvent pas tirer profit d’une architecture multi-processeur (pour cela en Python, il ne reste que l’option multi-processus). Ce qui, il faut bien l’admettre, ruine un peu l’intérêt…</p>
</div>
<div class="section" id="pour-en-savoir-plus">
<h2>pour en savoir plus<a class="headerlink" href="#pour-en-savoir-plus" title="Permalink to this headline">¶</a></h2>
<p>Cette présentation est juste une mise en perspective, elle est volontairement superficielle, d’autant que nous sommes clairement à côté de notre sujet. Si vous souhaitez approfondir certains de ces points (malheureusement sur ces sujets pointus les sources anglaises, même sur wikipedia, sont souvent préférables…) :</p>
<ul class="simple">
<li><p>sur la notion de thread : <a class="reference external" href="https://en.wikipedia.org/wiki/Thread_(computing)">Thread(computing) on wikipedia</a></p></li>
<li><p>sur le mécanisme de verrou :</p>
<ul>
<li><p><a class="reference external" href="https://www.youtube.com/watch?v=9lAuS6jsDgE">une illustration en vidéo (1’17) du verrou, très proche de notre exemple</a></p></li>
<li><p><a class="reference external" href="https://en.wikipedia.org/wiki/Lock_(computer_science)">wikipedia en anglais</a></p></li>
</ul>
</li>
<li><p>sur le <em><strong>GIL</strong></em> : <a class="reference external" href="https://realpython.com/python-gil/">https://realpython.com/python-gil/</a></p></li>
</ul>
<hr class="docutils" />
<div class="section" id="remarque-a-propos-des-verrous">
<h3>remarque à propos des verrous<a class="headerlink" href="#remarque-a-propos-des-verrous" title="Permalink to this headline">¶</a></h3>
<p>Le lecteur attentif remarquera une contradiction apparente, car dans notre présentation des verrous, on a introduit … un <strong>nouvel objet global</strong> <code class="docutils literal notranslate"><span class="pre">lock</span></code>; on pourrait craindre de n’avoir fait ici que de reporter le problème. N’aurait-on pas seulement déplacé le souci qu’on avait avec globale <code class="docutils literal notranslate"><span class="pre">a</span></code> sur la globale <code class="docutils literal notranslate"><span class="pre">lock</span></code> ?</p>
<p>En réalité ça n’est pas le cas, cette approche fonctionne vraiment et est massivement utilisée. Elle fonctionne notamment parce que le mécanisme de verrou est cette fois connu du scheduler, qui par conséquent peut garantir le comportement de <code class="docutils literal notranslate"><span class="pre">get_lock()</span></code> et <code class="docutils literal notranslate"><span class="pre">release_lock()</span></code>.</p>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="b-s1-programmation-asynchrone.html" title="previous page">programmation asynchrone</a>
    <a class='right-next' id="next-link" href="b-s2-examples.html" title="next page">premiers exemples</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Thierry Parmentelat<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>