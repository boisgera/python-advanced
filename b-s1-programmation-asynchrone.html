
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>programmation asynchrone &#8212; Python Avancé</title>
    
  <link href="_static/css/theme.css" rel="stylesheet" />
  <link href="_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinx-book-theme.5f77b4aec8189eecf79907ce328c390d.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Pourquoi les threads c’est délicat ?" href="b-s1-z1-thread-safety.html" />
    <link rel="prev" title="rappels" href="b-01-os-basics.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      <h1 class="site-logo" id="site-title">Python Avancé</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="1-01-snake.html">
   UE12 - Python avancé
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  types de base
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="2-01-numbers.html">
   les nombres
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="2-02-containers-1.html">
   les containers (1/2)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="2-03-strings.html">
   chaines et binaire (
   <code class="docutils literal notranslate">
    <span class="pre">
     str
    </span>
   </code>
   et
   <code class="docutils literal notranslate">
    <span class="pre">
     bytes
    </span>
   </code>
   )
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="2-04-files.html">
   les fichiers
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="2-05-containers-2.html">
   les containers (2/2)
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  présentation
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="3-11-pep008.html">
   présentation du code
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  itérations
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="4-11-iterations-1.html">
   les itérations en Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="4-12-iterations-2.html">
   les itérations - suite
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  classes
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="5-11-classes.html">
   classes : rappels (1)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="5-12-dunder-specials.html">
   classes : rappels (2)
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  fonctions
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="6-00-intro.html">
   cours 6/9 : fonctions
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  regexps
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="7-10-regexps.html">
   expressions régulières
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  générateurs
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="7-20-generators.html">
   les générateurs
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  héritage
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="7-30-inheritance.html">
   POO &amp; héritage
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  organisation des sources
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="8-10-imports-sources.html">
   Imports et organisation du code
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  divers
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="9-10-argparse.html">
   écrire un lanceur / point d’entrée
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="9-11-properties.html">
   properties
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  notebooks interactifs
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="a-a1-profiling.html">
   étude de performances
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="a-b1-linting.html">
   Qualité du code
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="a-c3-notebooks-interactifs.html">
   Notebooks interactifs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="a-c4-animations-matplotlib.html">
   Animations interactives avec
   <code class="docutils literal notranslate">
    <span class="pre">
     matplotlib
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="a-c5-bokeh-et-al.html">
   Autres bibliothèques de visualisation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="a-c6-fourier-k3d.html">
   Application à la transformée de Fourier
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="a-x1-taylor.html">
   Le théorème de Taylor illustré
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="a-x2-coronavirus.html">
   Coronavirus
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="a-x3-potentials.html">
   Tracés de champs de vitesses
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Python asynchrone
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="b-01-os-basics.html">
   rappels
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   programmation asynchrone
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="b-s1-z1-thread-safety.html">
   Pourquoi les
   <em>
    threads
   </em>
   c’est délicat ?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="b-s2-examples.html">
   premiers exemples
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="b-s3-ecosysteme.html">
   <code class="docutils literal notranslate">
    <span class="pre">
     asyncio
    </span>
   </code>
   : historique et écosystème
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="b-s4-async-with-for.html">
   extensions asynchrones du langage
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="b-s6-av-event-loops.html">
   boucle d’événements
   <code class="docutils literal notranslate">
    <span class="pre">
     asyncio
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="b-s7-libraries.html">
   les librairies disponibles
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        <a class="dropdown-buttons"
            href="_sources/b-s1-programmation-asynchrone.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download notebook file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/b-s1-programmation-asynchrone.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/ue12/python-advanced"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/ue12/python-advanced/issues/new?title=Issue%20on%20page%20%2Fb-s1-programmation-asynchrone.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/ue12/python-advanced/edit/main/notebooks/b-s1-programmation-asynchrone.md"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/ue12/python-advanced/main?urlpath=tree/notebooks/b-s1-programmation-asynchrone.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#typologie-d-applications">
   typologie d’applications
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#requete-a-un-serveur">
   requête à un serveur
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deux-requetes-en-sequence">
   deux requêtes en séquence
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#processus-simple">
   processus simple
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#avantages-inconvenients">
   avantages / inconvénients
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#threads">
   threads
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id1">
   avantages / inconvénients
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#commutations-de-contexte-1">
   commutations de contexte (1)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#deux-pages-telechargees-par-2-threads-differents">
     deux pages téléchargées par 2 threads différents
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#commutations-de-contexte-2">
   commutations de contexte (2)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#callbacks">
   callbacks
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#et-asyncio-la-dedans">
   et
   <code class="docutils literal notranslate">
    <span class="pre">
     asyncio
    </span>
   </code>
   là dedans
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#callback-vs-coroutine">
   callback
   <em>
    vs
   </em>
   coroutine
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#take-away-message">
   take away message
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <p><span style="float:left;">Licence CC BY-NC-ND</span><span style="float:right;">Thierry Parmentelat<img alt="_images/inria-25-alpha.png" src="_images/inria-25-alpha.png" /></span><br/></p>
<div class="section" id="programmation-asynchrone">
<h1>programmation asynchrone<a class="headerlink" href="#programmation-asynchrone" title="Permalink to this headline">¶</a></h1>
<p>Cette semaine nous allons parler de
programmation asynchrone. En effet
depuis la version 3.5, Python contient
une nouveauté assez intéressante pour
traiter ce type de programmation, c’est
la notion de coroutines, en conjonction
avec librairie asyncio.</p>
<p>Dans cette première séquence nous allons
essayer de comprendre ce qu’on veut dire
par programmation asynchrone, et voir
les différentes approches qu’on peut
utiliser pour traiter ce genre de
problèmes.</p>
<div class="section" id="typologie-d-applications">
<h2>typologie d’applications<a class="headerlink" href="#typologie-d-applications" title="Permalink to this headline">¶</a></h2>
<p>Pour commencer je vais introduire une
distinction entre deux types
d’applications informatiques. On
distingue traditionnellement entre les
programmes qui sont limités par le
processeur, et ceux qui sont limités par
les entrées sorties - en anglais on
dirait CPU-intensive vs IO-intensive.</p>
<ul class="simple">
<li><p>CPU-intensive</p></li>
<li><p>IO-intensive</p></li>
</ul>
<p>Un programme qui va essayer de casser un
mot de passe en essayant tous les mots
d’un dictionnaire, ou une application de
simulation météo qui passe son temps à
dérouler des équations mathématiques,
sont des exemples qui sont
CPU-intensive.
C’est ce type d’applications qu’on a envisagés dans les cours de Basile Marchand,
ce n’est pas du tout la cible ici, on n’en
parlera plus.</p>
<p>À l’inverse, une application qui irait
lire systématiquement toutes les pages
d’internet, comme le robot google, est
une application IO-intensive, et c’est
ce type d’applications qui est visé.</p>
<p>Contrairement à la première famille, on
ne peut pas accélérer ce type
d’applications en ajoutant des
ressources CPU, car ce n’est pas ça le
problème.</p>
<p>Si je reviens à mon robot, pour chaque
page que l’on va chercher, notre
programme commence par ouvrir une
connexion TCP, puis crée une requête
HTTP, bref sans rentrer dans les détails
on peut schématiser ça comme ceci :</p>
</div>
<div class="section" id="requete-a-un-serveur">
<h2>requête à un serveur<a class="headerlink" href="#requete-a-un-serveur" title="Permalink to this headline">¶</a></h2>
<p><img alt="délais dans les traitements" src="_images/w8-s1-av-fig1.png" /></p>
<p>une suite d’aller-retours entre le robot
et le serveur web. Ici le temps va de
haut en bas: et chacune des deux
colonnes représente l’occupation du CPU
pour les deux machines en question, à
gauche le robot, le client, et à droite
le serveur qui lui fournit la page web.
À cause du délai dans les transmissions
et du temps de réponse du serveur, vous
observez que le processeur qui héberge
le robot n’est pas bien utilisé, il
attend bêtement pendant la plus grosse
partie du travail.</p>
</div>
<div class="section" id="deux-requetes-en-sequence">
<h2>deux requêtes en séquence<a class="headerlink" href="#deux-requetes-en-sequence" title="Permalink to this headline">¶</a></h2>
<p>Lorsqu’on a besoin de plusieurs pages,
disons 2 pour commencer, voici ce qu’on
obtient en contactant les deux serveurs
de manière séquentielle. Le temps total
correspond bien entendu à la somme des
temps qu’il faut pour télécharger chaque
page, et c’est très inefficace du point
de vue de l’utilisation du processeur,
qui reste largement sous-utilisé.</p>
<p>On a envie d’améliorer les performances
de notre robot, et ceci à ressources
constantes. On va voir que notre
problème ici, c’est le modèle dit de
programmation synchrone, je veux dire,
le fait que notre client attende en
bloquant, et c’est tout ce temps perdu à
attendre qu’on va pouvoir mettre à profit.</p>
<p><img alt="délais dans les traitements" src="_images/w8-s1-av-fig2.png" /></p>
</div>
<div class="section" id="processus-simple">
<h2>processus simple<a class="headerlink" href="#processus-simple" title="Permalink to this headline">¶</a></h2>
<p>Avant de continuer, j’aimerais faire
quelques rappels sur le fonctionnement
des ordinateurs. Tout d’abord, il est
bien évident qu’un ordinateur sait faire
plusieurs choses à la fois, et notamment
grâce à la notion de processus. C’est
quoi un processus ? C’est une
abstraction offerte par le système
d’exploitation, pour justement faire
tourner plusieurs programmes différents
en même temps.</p>
<p>C’est une notion qui vise à fournir un
maximum d’isolation : en simplifiant à
l’extrême, un processus possède un
espace mémoire qui lui est propre, ainsi
que une pile (qui contient le contexte
associé aux appels de fonctions), et un
pointeur d’avancement (qui dit où on en
est dans le programme).</p>
<p><img alt="single-thread" src="_images/w8-s1-av-fig3.png" /></p>
</div>
<div class="section" id="avantages-inconvenients">
<h2>avantages / inconvénients<a class="headerlink" href="#avantages-inconvenients" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>parallèlisme</p></li>
<li><p>isolation</p></li>
</ul>
<ul class="simple">
<li><p><em>trop</em> d’isolation</p></li>
<li><p>échelle : 10x - 100x - on ne peut pas s’amuser à créer les processus par milliers ou dizaines de milliers</p></li>
</ul>
</div>
<div class="section" id="threads">
<h2>threads<a class="headerlink" href="#threads" title="Permalink to this headline">¶</a></h2>
<p>La notion de thread a été ajoutée par la
suite, pour permettre justement d’avoir
plusieurs traitements en parallèle, mais
qui partagent un espace mémoire.</p>
<p>Ce qui fait qu’on peut voir un processus
comme contenant un ou plusieurs threads,
qui partagent le même espace mémoire.</p>
<p>Avec cette notion de threads, on peut
penser avoir une bonne solution pour
traiter notre classe de problèmes.</p>
<p><img alt="multi-thread" src="_images/w8-s1-av-fig4.png" /></p>
</div>
<div class="section" id="id1">
<h2>avantages / inconvénients<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>Par contre, les threads présentent un
inconvénient majeur, qui rend leur
utilisation très délicate.</p>
<ul>
<li><p>disponible en python</p>
<p><a class="reference external" href="https://docs.python.org/3/library/threading.html#module-threading"><code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">threading</span></code></a></p>
</li>
</ul>
<ul class="simple">
<li><p>utilisation <strong>très</strong> délicate</p></li>
<li><p>échelle 1000x - on peut en créer un peu plus que de processus, mais pas des dizaines de milliers non plus</p></li>
</ul>
</div>
<div class="section" id="commutations-de-contexte-1">
<h2>commutations de contexte (1)<a class="headerlink" href="#commutations-de-contexte-1" title="Permalink to this headline">¶</a></h2>
<div class="section" id="deux-pages-telechargees-par-2-threads-differents">
<h3>deux pages téléchargées par 2 threads différents<a class="headerlink" href="#deux-pages-telechargees-par-2-threads-differents" title="Permalink to this headline">¶</a></h3>
<p>Dans le cas du robot qui télécharge les
pages, on n’a qu’à créer un thread par
page, et on commencera alors à utiliser
effectivement le processeur de manière
beaucoup plus optimale.</p>
<p>Les threads sont aujourd’hui utilisés
dans de très nombreux contextes, et
notamment en python grâce à la librairie
<code class="docutils literal notranslate"><span class="pre">threading</span></code>.</p>
<p><img alt="2 threads" src="_images/w8-s1-av-fig5.png" /></p>
</div>
</div>
<div class="section" id="commutations-de-contexte-2">
<h2>commutations de contexte (2)<a class="headerlink" href="#commutations-de-contexte-2" title="Permalink to this headline">¶</a></h2>
<p>Avec un thread par page web, on obtient
quelque chose comme ceci; cela veut dire
que du point de vue du développeur, si
je zoome un peu sur le début du
traitement</p>
<p><img alt="zoom" src="_images/w8-s1-av-fig6.png" /></p>
<p>on voit qu’il faut bien tout de même,
d’une manière ou d’une autre, donner la
main à chacun de ces threads tour à
tour, et le problème général des
threads, c’est que le passage d’un
thread à l’autre, qu’on appelle une
commutation de contexte, est décidé par
un tiers - le scheduler; et chacun de
ces deux morceaux de code tourne de son
coté sans avoir de contrôle sur ces
changements de contexte, qui peuvent se
produire n’importe quand.</p>
<p>Du coup, les threads partagent
effectivement les données, mais c’est un
peu la boîte de Pandorre, car lorsqu’il
est effectivement question de faire des
accès simultanés à une donnée, se posent
des problèmes de section critique, de
verrou, de famine, qui rendent la
programmtion multi-thread très délicate,
et en pratique réservée à des
spécialistes.</p>
</div>
<div class="section" id="callbacks">
<h2>callbacks<a class="headerlink" href="#callbacks" title="Permalink to this headline">¶</a></h2>
<p>Il nous faut aussi parler brièvement du
mécanisme de callbacks, qui vient
notamment des applications de type
interface utilisateur, dans lesquelles
cette problèmatique de programmation
asynchrone est très présente; en effet
on est en plein dans le spectre, lorsque
vous êtes devant votre browser il se
passe énormément de choses différentes
en même temps, et comme les humains ne
sont pas particulièrement patients il
est crucial d’avoir les temps de
réaction les plus rapides possible.</p>
<ul class="simple">
<li><p>associer à un événement</p></li>
<li><p>une fonction à exécuter</p></li>
</ul>
<p>C’est pourquoi les callbacks sont par
exemple omniprésentes dans la
programmation JavaScript. Le principe
est de n’utiliser qu’un seul thread,
mais de découper le code en fonctions
plus petites.</p>
<p>Le gros inconvénient avec cette
approche, c’est qu’on est amené à
saucissonner son code en tout petits
morceaux, ce qui rend les choses
passablement illisibles, et que c’est du
coup presque impossible d’implémenter
comme ça des logiques un peu complexes.</p>
<ul class="simple">
<li><p>induit un découpage du code en petits morceaux</p></li>
<li><p>logique difficile à suivre</p></li>
</ul>
</div>
<div class="section" id="et-asyncio-la-dedans">
<h2>et <code class="docutils literal notranslate"><span class="pre">asyncio</span></code> là dedans<a class="headerlink" href="#et-asyncio-la-dedans" title="Permalink to this headline">¶</a></h2>
<p>Le  paradigme que propose python
pour la programmation asynchrone repose
sur la notion de coroutine; c’est une
alternative assez élégante aux threads
et aux callbacks, et qui permet de
concevoir des algorithmes dans lesquels
plusieurs traitements s’effectuent <strong>en
parallèle</strong> mais <strong>dans un seul thread</strong>, avec
du code qui n’est pas défiguré par un
découpage en callbacks, et avec un
contrôle fin par le programmeur des
points du programme où il va être
possible de changer de contexte.</p>
<p>Je signale d’ailleurs à votre curiosité
que des mécanismes similaires existent
aussi dans des langages comme C#, Rust et Go par exemple.</p>
<ul class="simple">
<li><p>notion de <strong>coroutines</strong></p></li>
<li><p>qui s’exécutent en parallèle</p></li>
<li><p>mais dans <strong>un seul thread</strong></p></li>
<li><p>avec du code <strong>lisible</strong></p></li>
<li><p>en donnant du contrôle sur les changements de contexte</p></li>
<li><p>et sans besoin de saucissonner son code en callbacks</p></li>
<li><p>échelle 10 000x - 100 000x</p></li>
</ul>
</div>
<div class="section" id="callback-vs-coroutine">
<h2>callback <em>vs</em> coroutine<a class="headerlink" href="#callback-vs-coroutine" title="Permalink to this headline">¶</a></h2>
<p>Je vous montre ici un exemple de
coroutine dans un
langage imaginaire, il s’agit d’un
serveur pour le fameux protocole
‘ping-pong` ou encore ‘retour à
l’envoyeur’, dans lequel le serveur se
contente de renvoyer au client
exactement ce qu’il reçoit.</p>
<p>Vous avez en premier une version avec
callback, et ensuite une version avec
coroutine, le code parle de lui-même.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">on</span> <span class="n">écrirait</span> <span class="n">comme</span> <span class="n">ceci</span> 
<span class="o">//</span> <span class="n">en</span> <span class="n">pseudo</span><span class="o">-</span><span class="n">JavaScript</span>

<span class="n">function</span> <span class="n">pong_handler</span><span class="p">(</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">client</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">function</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">client</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="s1">&#39;data_written&#39;</span><span class="p">,</span> <span class="n">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="p">});</span>
        <span class="n">client</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># ce qui en pseudo-Python </span>
<span class="c1"># serait écrit comme ceci</span>

<span class="k">async</span> <span class="n">pong_handler</span><span class="p">():</span>
    <span class="n">client</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="take-away-message">
<h2>take away message<a class="headerlink" href="#take-away-message" title="Permalink to this headline">¶</a></h2>
<p>Pour résumer et conclure cette
introduction, retenez qu’avec asyncio,
vous pourrez obtenir un comportement
comme celui dessiné ci-dessous, qui est optimal
vis-à-vis de l’utilisation du temps,</p>
<ul class="simple">
<li><p><strong>sans</strong> avoir à <strong>défigurer votre code</strong>,
c’est-à-dire avec du code quasiment
identique à ce qu’on aurait écrit en
mode séquentiel,</p></li>
<li><p>et ceci en utilisant <strong>un seul thread</strong></p></li>
<li><p>ce qui permet d’envisager de traiter un très grand nombre de choses en parallèle</p></li>
</ul>
<p><img alt="avec asyncio" src="_images/w8-s1-av-fig7.png" /></p>
<p>On va voir ça dans les sections suivantes…</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="b-01-os-basics.html" title="previous page">rappels</a>
    <a class='right-next' id="next-link" href="b-s1-z1-thread-safety.html" title="next page">Pourquoi les <em>threads</em> c’est délicat ?</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Thierry Parmentelat<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>